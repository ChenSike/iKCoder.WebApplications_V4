<!DOCTYPE html>
<html>
<head>
    <title>深圳市龙岗区依山郡小学</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link href="image/logotop.ico" rel="shortcut icon" type="image/x-icon" />
    <link rel="stylesheet" href="style/tether.min.css">
    <link rel="stylesheet" href="style/bootstrap.css">
    <link rel="stylesheet" href="style/font-awesome.min.css">
    <script src="javascript/jquery-3.2.1.min.js"></script>
    <script src="javascript/tether.min.js"></script>
    <script src="javascript/bootstrap.js"></script>
    <script src="javascript/common.js"></script>
    <script src="javascript/xmloperator.js"></script>
    <style>
        div.custom-global-alert {
            position: absolute;
            top: 0px;
            width: 100%;
            text-align: center;
            z-index: 19999;
        }

        div.alert-mask-custom {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            z-index: 19998;
            background-color: rgb(0,0,0);
            opacity: 0.5;
            display: none;
        }
    </style>
</head>
<body style="font-family:微软雅黑;">
    <div class="container-fluid text-center" id="wrap_Sign">
        <div class="row">
            <div class="col-sm-12 mt-4 mb-4">
                <h4><i class="fa fa-american-sign-language-interpreting" style="padding-right:10px; color: forestgreen;" aria-hidden="true"></i>依小家校通</h4>
            </div>
        </div>
        <div class="row" id="row_SignIn_1">
            <div class="col-sm-12">
                <div class="card text-center">
                    <div class="card-header"><b>Sign In</b></div>
                    <div class="card-block">
                        <form>
                            <div class="form-group text-left">
                                <label for="txt_SignIn_Number">手机号码</label>
                                <input type="number" class="form-control" id="txt_SignIn_Number" aria-describedby="" placeholder="请输入手机号码">
                            </div>
                        </form>
                    </div>
                    <div class="card-footer text-muted">
                        <button type="button" class="btn btn-primary" id="btn_SignIn_Next">确认</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="row_SignIn_2" style="display:none;">
            <div class="col-sm-12">
                <div class="card text-center">
                    <div class="card-header"><b>Sign In</b></div>
                    <div class="card-block">
                        <form>
                            <div class="form-group text-left">
                                <label for="txt_SignIn_PWD">登录密码</label>
                                <input type="password" class="form-control" id="txt_SignIn_PWD" aria-describedby="" placeholder="请输入登录密码">
                            </div>
                        </form>
                    </div>
                    <div class="card-footer">
                        <button type="button" class="btn btn-secondary" id="btn_SignIn_ForgetPWD">忘记密码</button>
                        <button type="button" class="btn btn-primary" id="btn_SignIn_OK">&nbsp;&nbsp;登&nbsp;&nbsp;&nbsp;&nbsp;录&nbsp;&nbsp;</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="row_FindPWD" style="display:none;">
            <div class="col-sm-12">
                <div class="card text-center">
                    <div class="card-header"><b>Find Password</b></div>
                    <div class="card-block">
                        <form>
                            <div class="form-group text-left">
                                <label for="txt_FindPWD_Number">手机号码</label>
                                <input type="number" class="form-control" id="txt_FindPWD_Number" aria-describedby="" placeholder="请输入手机号码" readonly>
                            </div>
                            <div class="form-group text-left">
                                <label for="txt_FindPWD_IDNumber">身份证后六位</label>
                                <input type="password" class="form-control" id="txt_FindPWD_IDNumber" aria-describedby="" placeholder="请输入身份证后六位">
                            </div>
                            <div class="form-group text-left">
                                <label for="txt_FindPWD_PWD">新密码</label>
                                <input type="password" class="form-control" id="txt_FindPWD_PWD" aria-describedby="" placeholder="请输入至少长度为6的新登录密码">
                            </div>
                            <div class="form-group text-left">
                                <label for="txt_FindPWD_ConfirmPWD">确认新密码</label>
                                <input type="password" class="form-control" id="txt_FindPWD_ConfirmPWD" aria-describedby="" placeholder="请再次输入新登录密码">
                            </div>
                        </form>
                    </div>
                    <div class="card-footer text-muted">
                        <button type="button" class="btn btn-primary" id="btn_FindPWD_OK">确认</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row" id="row_SignUp" style="display:none;">
            <div class="col-sm-12">
                <div class="card text-center">
                    <div class="card-header"><b>Sign Up</b></div>
                    <div class="card-block">
                        <form>
                            <div class="form-group text-left">
                                <label for="txt_SignUp_Number">手机号码</label>
                                <input type="number" class="form-control" id="txt_SignUp_Number" aria-describedby="" readonly>
                            </div>
                            <div class="form-group text-left">
                                <label for="txt_SignUp_StudentName">学生姓名</label>
                                <input type="text" class="form-control" id="txt_SignUp_StudentName" aria-describedby="" placeholder="请输入学生姓名">
                            </div>
                            <div class="form-group text-left">
                                <label for="txt_SignUp_ParentName">家长姓名</label>
                                <input type="text" class="form-control" id="txt_SignUp_ParentName" aria-describedby="" placeholder="请输入家长姓名">
                            </div>
                            <div class="form-group text-left">
                                <label for="sel_SignUp_Class">所在班级</label>
                                <div class="row">
                                    <div class="col-4">
                                        <select id="sel_SignUp_Class_Grade" class="form-control">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                        </select>
                                    </div>
                                    <label for="sel_SignUp_Class_Grade" class="col-2 col-form-label">年</label>
                                    <div class="col-4">
                                        <select id="sel_SignUp_Class_Class" class="form-control">
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                        </select>
                                    </div>
                                    <label for="sel_SignUp_Class_Class" class="col-2 col-form-label">班</label>
                                </div>
                            </div>
                            <div class="form-group text-left">
                                <label for="txt_SignUp_PWD">登录密码</label>
                                <input type="password" class="form-control" id="txt_SignUp_PWD" aria-describedby="" placeholder="请输入至少长度为6的登录密码">
                            </div>
                            <div class="form-group text-left">
                                <label for="txt_SignUp_ConfirmPWD">确认密码</label>
                                <input type="password" class="form-control" id="txt_SignUp_ConfirmPWD" aria-describedby="" placeholder="请再次输入登录密码">
                            </div>
                            <div class="form-group text-left">
                                <label for="txt_SignUp_IdNuimber">身份证后六位</label>
                                <input type="password" class="form-control" id="txt_SignUp_IdNuimber" aria-describedby="" placeholder="请输入身份证后六位用于找回密码">
                            </div>
                        </form>
                    </div>
                    <div class="card-footer text-muted">
                        <button type="button" class="btn btn-info" id="btn_SignUp_Back">返回</button>
                        <button type="button" class="btn btn-primary" id="btn_SignUp_OK">注册</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="container-fluid" id="wrap_Confirm">
        <div class="row" id="row_Confirm_None">
            <div class="col mt-4 text-center">
                <b>目前没有需确认的事项.</b>
            </div>
        </div>
        <div class="row" id="row_Confirm_Message">
            <div class="col-sm-12">
                <div class="card mt-4">
                    <div class="card-header text-center">
                        <b>待确认签名的事项</b></br>
                        <!--<b>签名截止时间: <span id="lb_Confirm_EndDate">2018-01-01</span></b>-->
                    </div>
                    <div class="card-block">
                        <ul id="list_Confirm_Items"></ul>
                        <div>签名确认后表明您已完全知悉此事项的细则, 并完全同意.</div>
                    </div>
                    <div class="card-footer text-center">
                        <button type="button" class="btn btn-primary" id="btn_Confirm_Sign">签名确认</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-5" id="row_Confirm_Success">
            <div class="col-sm-12 mt-5 text-center">
                <b>确认签名成功, 感谢您的参与</b>
            </div>
        </div>
    </div>
    <div class="container-fluid" id="wrap_Management">
        <div class="row" id="row_Management">
            <div class="col mt-4 text-center">
            </div>
        </div>
    </div>
    <footer id="footer" style="height:25px;">
        <div class="footer-txt">
            <div class="container-fluid">
                <div class="row justify-content-center">
                    <div class="col-sm-12 text-center">
                        <span style="line-height:25px; font-size:14px; color:#cccccc;">
                            深圳市龙岗区依山郡小学
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <script>
        $(document).ready(function () {
            var type = _getQueryString('type');
            if (type == 'm') {
                //$("#wrap_Sign").hide();
                //$("#wrap_Confirm").hide();
                //$("#wrap_Management").show();
                //ajaxFunction(_getRequestURL('api/users/Set_Login.aspx', null), '<root></root>', function (response) {
                //    var msg = $(responseData).find('msg');
                //    if (msg.length > 0) {
                //        loadFullData(responseData);
                //    }
                //});
            } else {
                $("#wrap_Confirm").hide();
                $("#wrap_Management").hide();

                $("#btn_SignIn_Next").on('click', function () {
                    var tmpVal = $("#txt_SignIn_Number").val().trim();
                    if (tmpVal.length != 11 || parseInt(tmpVal) + '' != tmpVal || !(/^1(3|4|5|7|8)\d{9}$/.test(tmpVal))) {
                        showAlert('您输入了非法的手机号码, 请重新输入');
                    } else {
                        ajaxFunction(_getRequestURL('api/users/Set_CheckUserExisted.aspx', { symbol: tmpVal }), '<root></root>', function (responseData) {
                            var msg = $(responseData).find('msg');
                            if (msg.length > 0 && msg.attr('msg') == 'true') {
                                showInputPWD();
                            } else {
                                showSignUp();
                            }
                        });
                    }
                });

                $("#btn_SignIn_ForgetPWD").on('click', function () {
                    showFindPWD();
                });

                $("#btn_SignIn_OK").on('click', function () {
                    if ($("#txt_SignIn_PWD").val().length == 0) {
                        showAlert('请输入登录密码');
                    } else {
                        flag = true;
                        if (!flag) {
                            showAlert('登录密码与用户手机号码不匹配, 请重新输入登录密码');
                        } else {
                            signIn();
                        }
                    }
                });

                $("#btn_SignUp_Back").on('click', function () {
                    adjustRowStatus(0);
                });

                $("#btn_SignUp_OK").on('click', function () {
                    signUp();
                });

                $("#btn_FindPWD_OK").on('click', function () {
                    findPWD();
                });

                $("#btn_Confirm_Sign").on('click', function () {
                    ajaxFunction(_getRequestURL('api/items/Set_Signed.aspx', null), "<root></root>", function (responseData) {
                        var msg = $(responseData).find('msg');
                        if (msg.length > 0) {
                            $("#row_Confirm_None").hide();
                            $("#row_Confirm_Message").hide();
                            $("#row_Confirm_Success").show();
                        }
                    });
                });

                adjustRowStatus(0);
            }
        });

        function showInputPWD() {
            adjustRowStatus(1);
        };

        function showSignUp() {
            $("#txt_SignUp_Number").val($('#txt_SignIn_Number').val());
            adjustRowStatus(2);
        };

        function showFindPWD() {
            adjustRowStatus(3);
            $("#txt_FindPWD_Number").val($("#txt_SignIn_Number").val().trim());
        };

        function showResetPWD() {
            adjustRowStatus(4);
        };

        function signIn() {
            if ($('#txt_SignIn_PWD').val().trim().length == 0) {
                showAlert('请输入登录密码');
                return;
            };

            var tmpData = '<root><symbol>' + $('#txt_SignIn_Number').val().trim() + '</symbol><password>' + $('#txt_SignIn_PWD').val().trim() + '</password></root>';
            ajaxFunction(_getRequestURL('api/users/Set_Login.aspx', null), tmpData, function (responseData) {
                var msg = $(responseData).find('msg');
                if (msg.length > 0) {
                    adjustConfirmWrap({});
                }
            });
        };

        function signUp() {
            var tmpNumber = $("#txt_SignUp_Number").val().trim();
            var tmpStdName = $("#txt_SignUp_StudentName").val().trim();
            var tmpParName = $("#txt_SignUp_ParentName").val().trim();
            var tmpClass = $("#sel_SignUp_Class_Class").val().trim();
            var tmpGrade = $("#sel_SignUp_Class_Grade").val().trim();
            var tmpPwd = $("#txt_SignUp_PWD").val().trim();
            var tmpCfmPWD = $("#txt_SignUp_ConfirmPWD").val().trim();
            var tmpIDNumber = $("#txt_SignUp_IdNuimber").val().trim();
            if (tmpStdName.length == 0) {
                showAlert('请输入学生姓名');
                return;
            }

            if (tmpParName.length == 0) {
                showAlert('请输入家长姓名');
                return;
            }

            if (tmpStdName.length == 0) {
                showAlert('请输入学生姓名');
                return;
            }

            if (tmpPwd.length < 6) {
                showAlert('请输入至少长度为6的登录密码');
                return;
            }

            if (tmpCfmPWD.length == 0) {
                showAlert('请确认登录密码');
                return;
            }

            if (tmpIDNumber.length == 0) {
                showAlert('请输入身份证后六位用于找回密码');
                return;
            }

            if (tmpPwd != tmpCfmPWD) {
                showAlert('两次输入的密码不同, 请重新输入');
                return;
            }

            var tmpData = '<root>' +
                '<symbol>' + tmpNumber + '</symbol>' +
                '<pwd>' + tmpPwd + '</pwd>' +
                '<pid>' + tmpIDNumber + '</pid>' +
                '<student_name>' + tmpStdName + '</student_name>' +
                '<name>' + tmpParName + '</name>' +
                '<grade>' + tmpGrade + '</grade>' +
                '<class>' + tmpClass + '</class>' +
                '</root>';
            ajaxFunction(_getRequestURL('api/users/Set_Reg.aspx', null), tmpData, function (responseData) {
                var msg = $(responseData).find('msg');
                if (msg.length > 0) {
                    tmpData = '<root><symbol>' + tmpNumber + '</symbol><password>' + tmpPwd + '</password></root>';
                    ajaxFunction(_getRequestURL('api/users/Set_Login.aspx', null), tmpData, function (responseData_1) {
                        var msg = $(responseData_1).find('msg');
                        if (msg.length > 0) {
                            adjustConfirmWrap({});
                        }
                    });
                }
            });
        };

        function adjustConfirmWrap(msgObj) {
            ajaxFunction(_getRequestURL('api/items/Get_CurrentItem.aspx', null), "<root></root>", function (responseData) {
                var msgs = $(responseData).find('msg');
                if (msgs.length > 0) {
                    //<msg header="Executed api : ASP.api_items_get_currentitem_aspx" code="executed" title="This is test" id="2" date="2017-11-21"/>
                    var msgObjs = [];
                    var tmpItem = null;
                    for (var i = 0; i < msgs.length; i++) {
                        tmpItem = $(msgs[i]);
                        msgObjs.push({ title: tmpItem.attr('title'), date: tmpItem.attr('date') });
                    }

                    $("#wrap_Sign").hide();
                    $("#wrap_Confirm").show();
                    if (msgObjs.length == 0) {
                        $("#row_Confirm_None").show();
                        $("#row_Confirm_Message").hide();
                        $("#row_Confirm_Success").hide();
                    } else {
                        $("#row_Confirm_None").hide();
                        $("#row_Confirm_Message").show();
                        $("#row_Confirm_Success").hide();
                        //$("#lb_Confirm_EndDate").text(msgObj.date.toLocaleDateString());
                        var ulWrap = $('#list_Confirm_Items');
                        for (var i = 0; i < msgObjs.length; i++) {
                            ulWrap.append('<li>[' + msgObjs[i].date + ']' + msgObjs[i].title + '</li>');
                        }
                    }
                }
            });
        }

        function findPWD() {
            var tmpNumber = $("#txt_FindPWD_Number").val().trim();
            var tmpIDNumber = $("#txt_FindPWD_IDNumber").val().trim();
            var tmpPwd = $("#txt_FindPWD_PWD").val().trim();
            var tmpCfmPWD = $("#txt_FindPWD_ConfirmPWD").val().trim();
            if (tmpIDNumber.length == 0) {
                showAlert('请输入身份证后六位');
                return;
            }

            if (tmpPwd.length < 6) {
                showAlert('请输入至少长度为6的新密码');
                return;
            }

            if (tmpCfmPWD.length == 0) {
                showAlert('请确认新密码');
                return;
            }

            if (tmpPwd != tmpCfmPWD) {
                showAlert('两次输入的密码不同, 请重新输入');
                return;
            }

            ajaxFunction(_getRequestURL('api/users/Set_ResetPwd.aspx', { symbol: tmpNumber, newpwd: tmpPwd, pid: tmpIDNumber }), "<root></root>", function (responseData) {
                var msg = $(responseData).find('msg');
                if (msg.length > 0 && msg.attr('msg') == 'true') {
                    adjustRowStatus(0);
                } else {
                    showAlert(msg.attr('msg'));
                }
            });
        };

        function adjustRowStatus(type) {
            $("#row_SignIn_1").hide();
            $("#row_SignIn_2").hide();
            $("#row_SignUp").hide();
            $("#row_FindPWD").hide();
            switch (type) {
                case 0:
                    $("#row_SignIn_1").show();
                    break;
                case 1:
                    $("#row_SignIn_2").show();
                    break;
                case 2:
                    $("#row_SignUp").show();
                    break;
                case 3:
                    $("#row_FindPWD").show();
                    break;
            }

            adjustHeight();
        };

        function adjustHeight() {
            var windowHeight = window.screen.availHeight;
            var containerHeight = $('#wrap_Sign').height();
            var footerHeight = $('footer').height();
            var bodyHeihgt = containerHeight + footerHeight;
            if (windowHeight >= bodyHeihgt) {
                $('body').height(windowHeight);
                $('footer').css('margin-top', windowHeight - containerHeight - footerHeight);
            } else {
                $('body').css('height', 'auto');
                $('footer').css('margin-top', 0);
            }
        };

        function showAlert(text) {
            if ($('.alert-mask-custom').length == 0) {
                $('body').append($('<div class="alert-mask-custom"></div>'));
            }

            $('.alert-mask-custom').show();
            $('body').append($('<div class="alert alert-warning alert-dismissable custom-global-alert" id="alert_All"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button><span>' + text + '</span></div>'));
            $('#alert_All').alert();
            $('#alert_All').bind('close.bs.alert', function () {
                $('.alert-mask-custom').hide();
            });
        };

        function loadFullData(responseData) {

        }

        function ajaxFunction(url, data, callback) {
            _registerRemoteServer();
            $.ajax({
                type: 'POST',
                async: true,
                url: url,
                data: data,
                success: function (response, status) {
                    if ($(response).find('err').length > 0) {
                        showAlert($(response).find('err').attr('msg'));
                    } else {
                        callback(response);
                    }
                },
                dataType: 'xml',
                xhrFields: {
                    withCredentials: true
                },
                error: function () {
                    showAlert('服务器出现错误, 请稍后再试');
                }
            });
        };

        function _registerRemoteServer() {
            return true;
            $.ajax({
                type: 'GET',
                async: true,
                data: '<root></root>',
                url: _getRequestURL(_gURLMapping.server.reg, { domain: window.location.origin }),
                success: function (xml, status) {
                },
                dataType: 'xml',
                xhrFields: {
                    withCredentials: true
                },
                error: function () {
                }
            });
        };

        function _getRequestURL(page, params) {
            var url = page + '?rnd=' + Date.now();
            if (params) {
                for (var key in params) {
                    url += '&' + key + '=' + params[key];
                }
            }

            return url;
        };

        function _getQueryString(key) {
            var tempArr = window.location.search.substr(1).split('&');
            for (var i = 0; i < tempArr.length; i++) {
                var strArr = tempArr[i].split('=');
                if (strArr[0] == key) {
                    return strArr[1];
                }
            }
        };
    </script>
</body>
</html>